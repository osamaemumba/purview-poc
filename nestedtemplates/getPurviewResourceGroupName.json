{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "utcValue": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Specifies the Azure location where the identity will be created."
      }
    },
    "newPurviewAccountName": {
      "type": "string"
    },
    "existingPurviewAccountName": {
      "type": "string"
    },
    "newOrExistingPurviewAccount": {
      "type": "string"
    }
  },
  "variables": {
    "dsIdentityName": "dsId"
  },
  "resources": [
    {
      "condition": "[equals(parameters('newOrExistingPurviewAccount'),'new')]",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "getNewPurviewResourceGroupName",
      "location": "[parameters('location')]",
      "kind": "AzurePowerShell",
      "dependsOn": [],
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities', variables('dsIdentityName'))]": {}
        }
      },
      "properties": {
        "forceUpdateTag": "[parameters('utcValue')]",
        "azPowerShellVersion": "6.0",
        "arguments": "[concat('-purviewAccountName', ' ', concat('\\\"', parameters('newPurviewAccountName'), '\\\"'))]",
        "scriptContent": "param([string] $purviewAccountName = $purviewAccountName)\n\rInstall-Module -Name \"Az.Accounts\" -Force\n\rInstall-Module -Name \"Az.Resources\" -Force\n\rConnect-AzAccount -Identity\n\r$purviewResourceGroup=(Get-AzResource -Name $purviewAccountName).ResourceId\n\r$DeploymentScriptOutputs = @{}\n\r$DeploymentScriptOutputs['purviewResourceGroup'] = $purviewResourceGroup",
        "timeout": "PT1H",
        "cleanupPreference": "OnSuccess",
        "retentionInterval": "P1D"
      }
    },
    {
      "condition": "[equals(parameters('newOrExistingPurviewAccount'),'existing')]",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "getExistingPurviewResourceGroupName",
      "location": "[parameters('location')]",
      "kind": "AzurePowerShell",
      "dependsOn": [],
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceID('Microsoft.ManagedIdentity/userAssignedIdentities', variables('dsIdentityName'))]": {}
        }
      },
      "properties": {
        "forceUpdateTag": "[parameters('utcValue')]",
        "azPowerShellVersion": "6.0",
        "arguments": "[concat('-purviewAccountName', ' ', concat('\\\"', parameters('existingPurviewAccountName'), '\\\"'))]",
        "scriptContent": "param([string] $purviewAccountName = $purviewAccountName)\n\rInstall-Module -Name \"Az.Accounts\" -Force\n\rInstall-Module -Name \"Az.Resources\" -Force\n\rConnect-AzAccount -Identity\n\r$purviewResourceGroup=(Get-AzResource -Name $purviewAccountName).ResourceId\n\r$DeploymentScriptOutputs = @{}\n\r$DeploymentScriptOutputs['purviewResourceGroup'] = $purviewResourceGroup",
        "timeout": "PT1H",
        "cleanupPreference": "OnSuccess",
        "retentionInterval": "P1D"
      }
    }
  ],
  "outputs": {
    "newPurviewResourceGroup": {
      "condition": "[equals(parameters('newOrExistingPurviewAccount'),'new')]",
      "value": "[reference('getNewPurviewResourceGroupName').outputs.newPurviewResourceGroup]",
      "type": "string"
    },
    "existingPurviewResourceGroup": {
      "condition": "[equals(parameters('newOrExistingPurviewAccount'),'existing')]",
      "value": "[reference('getExistingPurviewResourceGroupName').outputs.existingPurviewResourceGroup]",
      "type": "string"
    }
  }
}